5.5 交互控制
==============

5.5.1 Config&Msg&Event
----------------------

**Config**  ::

		"interact":{
			/* 交互参数 */
			"interact_timeout":"60000",
			"result_timeout":"5000"
		},
		
		"global":{
			/* 交互历史清除方式 */
			"clean_dialog_history":"auto"
		},	
		
		"speech": {
			/* 交互模式 */
			"interact_mode": "continuous",
		},


**Message**

	+---------------------------+---------+------+--------------------------------------------------------------------------------------------+
	|msgType（消息类型）        |  取值   | 返回 | | 说明                                                                                     |
	+---------------------------+---------+------+--------------------------------------------------------------------------------------------+
	|                           |  9      |  无  | | **设置麦克风阵列的拾音波束**                                                             |
	|CMD_SET_BEAM               |         |      | |  用arg1携带拾音波束号。                                                                  |
	+---------------------------+---------+------+--------------------------------------------------------------------------------------------+
	|CMD_UPLOAD_LEXICON         |  11     |  有  | | **上传用户识别热词**                                                                     |
	|                           |         |      | |                                                                                          |
	+---------------------------+---------+------+--------------------------------------------------------------------------------------------+
	|CMD_RESULT_VALIDATION_ACK  |   20    |  无  | | **结果确认**                                                                             |
	|                           |         |      | | 在接收到语义、听写、后处理的结果后5s内可发送该指令对结果进行确认，                       |
	|                           |         |      | | AIUI会认为该条结果有效，并重新开始AIUI交互超时的计时                                     |
	|                           |         |      |                                                                                            |
	|                           |         |      | | 关于交互超时的机制参看\ :ref:`AIUI配置 <aiui_cfg_label>`\ 中\ `interact_timeout`\ 的解释 |
	+---------------------------+---------+------+--------------------------------------------------------------------------------------------+
	|CMD_CLEAN_DIALOG_HISTORY   |   21    |  无  | | **清空交互历史**                                                                         |
	+---------------------------+---------+------+--------------------------------------------------------------------------------------------+
	
5.5.2 设置拾音波束
-------------------

用户唤醒AIUI之后，AIUI会增强唤醒角度（拾音波束号）上的拾音权重，抑制其他角度上拾音的效果，提高唤醒后的交互体验。
同时拾音波束号也支持动态设置，在唤醒后通过构造\ ``CMD_SET_BEAM``\ 消息（arg1是设置拾音波束号），发送给AIUI，
更改拾音波束号。

关于4、5、6麦中拾音波束号的定义参见\ :download:`麦克风设计参考 <麦克风设计参考V0.8.pdf>`\ 。

.. _upload_hot_words-label:

5.5.3 上传用户热词
------------------
通过\ ``CMD_UPLOAD_LEXICON``\ 上传热词，用户词表按格式组成JSON字符串， 放在params字段传入SDK。   
                                                       
具体格式::                                             
                                                       
     {                                                 
        "name":"userword",                             
        "content":"XXXX"                               
     }                                                 
                                                       
其中XXXX也为一个JSON字符串，示例::                     
                                                       
     {                                                 
         "userword": [{                                
                "name": "我的常用词",                  
                "words": ["佳晨实业",                  
                "蜀南庭苑",                            
                "高兰路",                              
                "复联二"]                              
            },                                         
            {                                          
                "name": "我的好友",                    
                "words": ["李馨琪",                    
                "鹿晓雷",                              
                "张集栋",                              
                "周家莉",                              
                "叶震珂",                              
                "熊泽萌"]                              
         }]                                            
     } 

5.5.4 延迟休眠
---------------

.. _valid_interact-label:

AIUI中有效交互的定义是交互的结果有语义结果，并且语义结果中的\ ``rc``\ 字段的值为0。
		
AIUI中如果持续一段时间（\ :ref:`配置文件 <aiui_cfg_label>`\ 中\ ``interact_timeout``\ 可配置）无有效交互，AIUI就会自动休眠。

如用户在AIUI后台的应用管理中只勾选了听写，那客户端收到的交互结果中会一直没有语义结果，
都算是无效交互，在持续一段时间（\ ``interact_timeout``\ ）后就会自动休眠。对接入AIUI第三方后
处理的情况，也是类似的情况，AIUI无法识别第三方后处理结果中的有效语义，故也算是是无效交互。

对于上述这种情况，AIUI提供\ ``CMD_RESULT_VALIDATION_ACK``\ \ :ref:`命令 <aiuimessage-label>`\ ，在接收到语义，
听写或者后处理结果后5秒内发送该条指令，AIUI即会认为该条结果为有效交互，并重新开始无效结果自动休眠的倒计时。



5.5.5 清除交互历史
-------------------

.. _clear_history-label:

AIUI支持多轮对话，如在问\ ``合肥今天的天气怎么样``\ 之后，再询问\ ``明天呢``\ ，AIUI会结合上一句询问合肥今天
天气的历史，就会会回答合肥明天的天气。

AIUI默认在休眠后唤醒会清除交互历史，在交互状态下唤醒，则不会清除交互历史。

AIUI清除历史的方式是\ :ref:`可配置的 <aiui_cfg_label>`\ ，默认为\ ``auto``\ 即是上面描述的模式。当配置成\ ``user``\ 值后，
用户可以通过发送\ ``CMD_CLEAN_DIALOG_HISTORY``\ 在任何时候手动清除交互的历史。

即使在上面两种情况下，客户端都不主动清除交互历史，服务端保存用户交互历史的时间也是有限的120秒。


5.5.6 交互模式
---------------

通过\ ``speech``\ 下的\ ``interact_mode``\ 参数配置AIUI的交互模式。

AIUI默认的交互模式是一次唤醒后可持续交互，对应配置值\ ``continuous``\ 。
另一配置值\ ``oneshot``\ 表示oneshot模式，在该交互模式下一次唤醒交互后即会自动休眠。